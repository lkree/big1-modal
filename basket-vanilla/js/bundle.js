"use strict";window.h={showWaitScreen:e=>h.show(e),hideWaitScreen:e=>h.hide(e),show:e=>h.removeClass(e,"hidden"),hide:e=>h.addClass(e,"hidden"),addClass:(e,t)=>h.handleClass(e,"add",t),removeClass:(e,t)=>h.handleClass(e,"remove",t),handleClass:(e,t,r)=>e.classList[t](r),createFragment:()=>document.createDocumentFragment(),setText:(e,t)=>e.textContent=t,getText:e=>e.textContent,setValue:(e,t)=>e.value=t,getValue:e=>e.value,setPhoto:(e,t)=>e.src=t,countPositionPrice:(e,t)=>+e*+t,glueNumber:e=>e.search(/ /g)?parseInt(e.split(" ").join("")):parseInt(e),addListOfEvents:(e,t)=>e.filter(e=>e[t]).forEach(e=>h.eventAdd(e.el,e.ev,e.listener)),eventAdd:(e,t,r)=>e.addEventListener(t,r)};{const e={module:document.querySelector(".basket__body"),waitScreen:document.querySelector(".wait-screen"),template:document.querySelector("template").content,dataPath:"./js/data.json"},t=Object.assign(e,{fullPositionsWrapper:e.module.querySelector(".basket__table tbody"),partialPositionsWrapper:e.module.querySelector(".basket__order-result"),partialPositionsInfo:e.module.querySelector(".basket__order-result-info"),specialCodeConfirmBtn:e.module.querySelector(".basket__order-promo-confirm"),specialCodeInput:e.module.querySelector(".basket__order-promo-input"),discountInfo:e.module.querySelector(".basket__order-result-discount-number"),deliveryInfo:e.module.querySelector(".basket__order-result-delivery-number"),totalPriceInfo:e.module.querySelector(".basket__order-total-number")});let r=e=>{const t={renderPosition:(e,r,{articleSelector:o,nameSelector:l,priceSelector:n,oldPriceSelector:a,countSelector:c,photoSelector:i,finalPriceSelector:s},{article:u,fullName:d,price:p,oldPrice:_,count:m,photo:S})=>{const b=e.cloneNode(!0);if(h.setText(b.querySelector(o),`Артикул: ${u}`),h.setText(b.querySelector(l),d),h.setText(b.querySelector(n),`${p} ₽`),h.setText(b.querySelector(c),`${m} штуки`),"full"===r){const e=t.getLocalFinalPrice(p,m);h.setText(b.querySelector(a),_?`${_} ₽`:""),h.setPhoto(b.querySelector(i),S),h.setText(b.querySelector(s),`${e} ₽`),h.setValue(b.querySelector(c),m)}return b},getLocalFinalPrice:(e=0,t=0)=>h.countPositionPrice(h.glueNumber(e),t).toLocaleString(),calculateTotalPrice:()=>{const t=e.fullPositionsWrapper.querySelectorAll(".basket__table-tr");let r=0;return t[0]?(1<t.length&&(r=[...t].reduce((e,t)=>h.glueNumber(h.getText(e.querySelector(".basket__product-price")))*+h.getValue(e.querySelector(".basket__product-count"))+h.glueNumber(h.getText(t.querySelector(".basket__product-price")))*+h.getValue(t.querySelector(".basket__product-count")))),1===t.length&&(r=h.glueNumber(h.getText(t[0].querySelector(".basket__product-price")))*+h.getValue(t[0].querySelector(".basket__product-count"))),r+=490):r},setTotalPrice:t=>h.setText(e.totalPriceInfo,`${t} ₽`),setDiscountInfo:t=>h.setText(e.discountInfo,t),setDelivery:()=>h.setText(e.deliveryInfo,0<e.fullPositionsWrapper.children.length?"+ 490р":0),rerenderTotalPrice:(e=t.calculateTotalPrice())=>t.setTotalPrice(e)},r={fullPositionsClickHandler:()=>{},onButtonAddSubClick:()=>{},onCountChange:()=>{},onRemovePositionClick:()=>{},onSpecialCodeConfirm:()=>{}},o=()=>(o.initiate=(({waitScreen:e,dataPath:r,template:n,fullPositionsWrapper:a,partialPositionsWrapper:c,partialPositionsInfo:i,specialCodeConfirmBtn:s,discountInfo:u,specialCodeInput:d})=>{const p=()=>(p.setWaitScreen=(()=>(h.showWaitScreen(e),p)),p.handleData=(()=>(fetch(r).then(e=>e.json()).then(e=>p.renderData(e)).then(h.hideWaitScreen(e)).then(l().create(u,d,c).listInitiate(a,s).add()).catch(t=>{h.hideWaitScreen(e),alert(t)}),p)),p.renderData=(({positions:e})=>{const r=()=>{let o,l,s,u;const d=t.renderPosition.bind(null,n.querySelector(".basket__table-tr"),"full",{articleSelector:".basket__product-article",nameSelector:".basket__product-name",priceSelector:".basket__product-price",oldPriceSelector:".basket__product-old-price",countSelector:".basket__product-count",photoSelector:".basket__product-photo",finalPriceSelector:".basket__table-product-final-price"}),p=t.renderPosition.bind(null,n.querySelector(".basket__order-position"),"partial",{articleSelector:".basket__order-position-article",nameSelector:".basket__order-position-name",priceSelector:".basket__order-position-price",countSelector:".basket__order-position-count"});return r.createFragments=(()=>(o=h.createFragment(),l=h.createFragment(),r)),r.createPositions=(()=>(s=e.map(d),u=e.map(p),r)),r.fillFragments=(()=>(s.forEach(e=>o.append(e)),u.forEach(e=>l.append(e)),r)),r.insertFragments=(()=>(a.append(o),c.insertBefore(l,i),r)),r.calculateTotalPrice=(()=>{const e=t.calculateTotalPrice();return t.setTotalPrice(e),r}),r.calculateDelivery=(()=>(t.setDelivery(),r)),r};return r().createFragments().createPositions().fillFragments().insertFragments().calculateTotalPrice().calculateDelivery(),p}),p);return p().setWaitScreen().handleData(),o}),o),l=()=>{let e=[];return l.create=((e,o,n)=>(r.onSpecialCodeConfirm=(()=>{let e;const r=()=>(r.checkCode=(()=>(e=o.value,r)),r.checkConditions=((e,t,o)=>(e?t():o(),r)),r.setWrongCode=(()=>(t.setDiscountInfo("Промокод неверный"),t.rerenderTotalPrice(),r)),r.setTrueCode=(()=>{const e=t.calculateTotalPrice(),o=.2*e;return t.setDiscountInfo(`${o} ₽`),t.rerenderTotalPrice(e-o),r}),r);r().checkCode().checkConditions("NY2020"===e,r.setTrueCode,r.setWrongCode)}),r.onRemovePositionClick=(e=>{const r=e.parentElement.parentElement;r.remove();const o=h.getText(r.querySelector(".basket__product-article")).split(": ")[1];[...n.querySelectorAll(".basket__order-position-article")].filter(e=>h.getText(e).split(": ")[1]===o)[0].parentElement.parentElement.remove(),t.rerenderTotalPrice(),t.setDelivery()}),r.onButtonAddSubClick=((e,o,l)=>{const n=e.parentElement.querySelector(".basket__product-count");l||(l="add"===o?+n.value+1:+n.value-1),n.value=l,t.rerenderTotalPrice();const a=+n.value;if(0>=a)return void r.onRemovePositionClick(e.parentElement);const c=e.parentElement.parentElement.parentElement,i=h.getText(c.querySelector(".basket__product-price")).split(" ₽")[0]||0,s=t.getLocalFinalPrice(i,a);h.setText(c.querySelector(".basket__table-product-final-price"),`${s} ₽`)}),r.fullPositionsClickHandler=(({target:e})=>{e.classList.contains("basket__table-product-remove")&&r.onRemovePositionClick(e),e.classList.contains("basket__order-promo-confirm")&&r.onSpecialCodeConfirm(),e.classList.contains("basket__product-add")&&r.onButtonAddSubClick(e,"add"),e.classList.contains("basket__product-sub")&&r.onButtonAddSubClick(e,"sub")}),l)),l.listInitiate=((t,o)=>(e=[{el:t,ev:"click",listener:r.fullPositionsClickHandler,initiate:!0},{el:o,ev:"click",listener:r.onSpecialCodeConfirm,initiate:!0}],l)),l.add=(()=>(h.addListOfEvents(e,"initiate"),l)),l};o().initiate(e)};r=r.bind(null,t),document.addEventListener("DOMContentLoaded",r)}