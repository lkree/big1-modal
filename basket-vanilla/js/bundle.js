"use strict";window.h={showWaitScreen:e=>h.show(e),hideWaitScreen:e=>h.hide(e),show:e=>h.removeClass(e,"hidden"),hide:e=>h.addClass(e,"hidden"),addClass:(e,t)=>h.handleClass(e,"add",t),removeClass:(e,t)=>h.handleClass(e,"remove",t),handleClass:(e,t,r)=>e.classList[t](r),createFragment:()=>document.createDocumentFragment(),setText:(e,t)=>e.textContent=t,getText:e=>e.textContent,setValue:(e,t)=>e.value=t,getValue:e=>e.value,setPhoto:(e,t)=>e.src=t,countPositionPrice:(e,t)=>+e*+t,glueNumber:e=>e.search(/ /g)?parseInt(e.split(" ").join("")):parseInt(e),addListOfEvents:(e,t)=>e.filter(e=>e[t]).forEach(e=>h.eventAdd(e.el,e.ev,e.listener)),eventAdd:(e,t,r)=>e.addEventListener(t,r)};{const e={module:document.querySelector(".basket__body"),waitScreen:document.querySelector(".wait-screen"),template:document.querySelector("template").content,dataPath:"./js/data.json"},t=Object.assign(e,{fullPositionsWrapper:e.module.querySelector(".basket__table tbody"),partialPositionsWrapper:e.module.querySelector(".basket__order-result"),partialPositionsInfo:e.module.querySelector(".basket__order-result-info"),specialCodeConfirmBtn:e.module.querySelector(".basket__order-promo-confirm"),specialCodeInput:e.module.querySelector(".basket__order-promo-input"),discountInfo:e.module.querySelector(".basket__order-result-discount-number"),deliveryInfo:e.module.querySelector(".basket__order-result-delivery-number"),totalPriceInfo:e.module.querySelector(".basket__order-total-number")});let r=e=>{const t={discount:!1,renderPosition:(e,r,{articleSelector:o,nameSelector:n,priceSelector:l,oldPriceSelector:i,countSelector:c,photoSelector:a,finalPriceSelector:s},{article:u,fullName:d,price:p,oldPrice:_,count:m,photo:S})=>{const b=e.cloneNode(!0);if(h.setText(b.querySelector(o),`Артикул: ${u}`),h.setText(b.querySelector(n),d),h.setText(b.querySelector(l),`${p} ₽`),h.setText(b.querySelector(c),`${m} штуки`),"full"===r){const e=t.getLocalFinalPrice(p,m);h.setText(b.querySelector(i),_?`${_} ₽`:""),h.setPhoto(b.querySelector(a),S),h.setText(b.querySelector(s),`${e} ₽`),h.setValue(b.querySelector(c),m)}return b},getLocalFinalPrice:(e=0,t=0)=>h.countPositionPrice(h.glueNumber(e),t).toLocaleString(),calculateTotalPrice:()=>{const t=e.fullPositionsWrapper.querySelectorAll(".basket__table-tr");let r=0;return t[0]?(1<t.length&&(r=[...t].reduce((e,t)=>h.glueNumber(h.getText(e.querySelector(".basket__product-price")))*+h.getValue(e.querySelector(".basket__product-count"))+h.glueNumber(h.getText(t.querySelector(".basket__product-price")))*+h.getValue(t.querySelector(".basket__product-count")))),1===t.length&&(r=h.glueNumber(h.getText(t[0].querySelector(".basket__product-price")))*+h.getValue(t[0].querySelector(".basket__product-count"))),r+=490):r},setTotalPrice:t=>h.setText(e.totalPriceInfo,`${t} ₽`),setDiscountInfo:t=>h.setText(e.discountInfo,t),setDelivery:()=>h.setText(e.deliveryInfo,0<e.fullPositionsWrapper.children.length?"+ 490р":0),rerenderTotalPrice:(e=t.calculateTotalPrice())=>t.setTotalPrice(e),calculateDiscount:(e=.2,r=t.calculateTotalPrice())=>r*e,rerenderDiscount:(r=t.calculateDiscount())=>{t.discount&&h.setText(e.discountInfo,`${r} ₽`)},rerenderDiscountAndPrice:(e=t.calculateTotalPrice(),r=t.calculateDiscount())=>{t.rerenderDiscount(),t.rerenderTotalPrice(e-r)}},r={fullPositionsClickHandler:()=>{},onButtonAddSubClick:()=>{},onCountChange:()=>{},onRemovePositionClick:()=>{},onSpecialCodeConfirm:()=>{},fullPositionsInputHandler:()=>{},onSpecialCodeKeyPress:()=>{}},o=()=>(o.initiate=(({waitScreen:e,dataPath:r,template:l,fullPositionsWrapper:i,partialPositionsWrapper:c,partialPositionsInfo:a,specialCodeConfirmBtn:s,discountInfo:u,specialCodeInput:d})=>{const p=()=>(p.setWaitScreen=(()=>(h.showWaitScreen(e),p)),p.handleData=(()=>(fetch(r).then(e=>e.json()).then(e=>p.renderData(e)).then(h.hideWaitScreen(e)).then(n().create(u,d,c).listInitiate(i,s,d).add()).catch(t=>{h.hideWaitScreen(e),alert(t)}),p)),p.renderData=(({positions:e})=>{const r=()=>{let o,n,s,u;const d=t.renderPosition.bind(null,l.querySelector(".basket__table-tr"),"full",{articleSelector:".basket__product-article",nameSelector:".basket__product-name",priceSelector:".basket__product-price",oldPriceSelector:".basket__product-old-price",countSelector:".basket__product-count",photoSelector:".basket__product-photo",finalPriceSelector:".basket__table-product-final-price"}),p=t.renderPosition.bind(null,l.querySelector(".basket__order-position"),"partial",{articleSelector:".basket__order-position-article",nameSelector:".basket__order-position-name",priceSelector:".basket__order-position-price",countSelector:".basket__order-position-count"});return r.createFragments=(()=>(o=h.createFragment(),n=h.createFragment(),r)),r.createPositions=(()=>(s=e.map(d),u=e.map(p),r)),r.fillFragments=(()=>(s.forEach(e=>o.append(e)),u.forEach(e=>n.append(e)),r)),r.insertFragments=(()=>(i.append(o),c.insertBefore(n,a),r)),r.calculateTotalPrice=(()=>{const e=t.calculateTotalPrice();return t.setTotalPrice(e),r}),r.calculateDelivery=(()=>(t.setDelivery(),r)),r};return r().createFragments().createPositions().fillFragments().insertFragments().calculateTotalPrice().calculateDelivery(),p}),p);return p().setWaitScreen().handleData(),o}),o),n=()=>{let e=[];return n.create=((e,o,l)=>(r.onSpecialCodeConfirm=(()=>{let e;const r=()=>(r.checkCode=(()=>(e=o.value,r)),r.checkConditions=((e,t,o)=>(e?t():o(),r)),r.setWrongCode=(()=>(t.discount=!1,t.setDiscountInfo("Промокод неверный"),t.rerenderTotalPrice(),r)),r.setTrueCode=(()=>(t.discount=!0,t.rerenderDiscountAndPrice(),r)),r);r().checkCode().checkConditions("NY2020"===e,r.setTrueCode,r.setWrongCode)}),r.onRemovePositionClick=(e=>{const r=e.parentElement.parentElement;r.remove();const o=h.getText(r.querySelector(".basket__product-article")).split(": ")[1];[...l.querySelectorAll(".basket__order-position-article")].filter(e=>h.getText(e).split(": ")[1]===o)[0].parentElement.parentElement.remove(),t.setDelivery(),t.rerenderDiscountAndPrice()}),r.onButtonAddSubClick=((e,o,n)=>{const l=e.parentElement.querySelector(".basket__product-count");n||(n="add"===o?+l.value+1:+l.value-1),l.value=n,t.rerenderTotalPrice();const i=+l.value;if(0>=i)return void r.onRemovePositionClick(e.parentElement);const c=e.parentElement.parentElement.parentElement,a=h.getText(c.querySelector(".basket__product-price")).split(" ₽")[0]||0,s=t.getLocalFinalPrice(a,i);h.setText(c.querySelector(".basket__table-product-final-price"),`${s} ₽`),t.rerenderDiscountAndPrice()}),r.fullPositionsClickHandler=(({target:e})=>{e.classList.contains("basket__table-product-remove")&&r.onRemovePositionClick(e),e.classList.contains("basket__order-promo-confirm")&&r.onSpecialCodeConfirm(),e.classList.contains("basket__product-add")&&r.onButtonAddSubClick(e,"add"),e.classList.contains("basket__product-sub")&&r.onButtonAddSubClick(e,"sub")}),r.fullPositionsInputHandler=(({target:e})=>{if(e.classList.contains("basket__product-count")){if(e.value=e.value.replace(/[\D]/gi,""),!e.value)return void r.onRemovePositionClick(e.parentElement);r.onButtonAddSubClick(e,null,e.value)}}),r.onSpecialCodeKeyPress=(({keyCode:e})=>{13===e&&r.onSpecialCodeConfirm()}),n)),n.listInitiate=((t,o,l)=>(e=[{el:t,ev:"click",listener:r.fullPositionsClickHandler,initiate:!0},{el:t,ev:"input",listener:r.fullPositionsInputHandler,initiate:!0},{el:o,ev:"click",listener:r.onSpecialCodeConfirm,initiate:!0},{el:l,ev:"keydown",listener:r.onSpecialCodeKeyPress,initiate:!0}],n)),n.add=(()=>(h.addListOfEvents(e,"initiate"),n)),n};o().initiate(e)};r=r.bind(null,t),document.addEventListener("DOMContentLoaded",r)}